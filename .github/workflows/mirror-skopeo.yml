name: Mirror GHCR openclaw/openclaw -> Docker Hub

on:
  schedule:
    - cron: "0 */6 * * *" # every 6 hours
  workflow_dispatch: {}

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Install tools (skopeo + jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo jq

      - name: Login to Docker Hub (for push)
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "$DOCKERHUB_TOKEN" | skopeo login docker.io -u "$DOCKERHUB_USERNAME" --password-stdin

      # Optional: login to GHCR (only needed if GHCR requires auth)
      # Some GitHub workflow validators reject `secrets.*` usage in `if:` at parse time.
      # So we always load the secrets into env and skip login if the token is empty.
      - name: Login to GHCR (optional)
        env:
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${GHCR_TOKEN:-}" ]; then
            echo "GHCR_TOKEN not set; skipping GHCR login."
            exit 0
          fi
          if [ -z "${GHCR_USERNAME:-}" ]; then
            echo "GHCR_USERNAME not set; defaulting to github.actor is not available here. Set GHCR_USERNAME secret if needed."
            exit 1
          fi
          echo "$GHCR_TOKEN" | skopeo login ghcr.io -u "$GHCR_USERNAME" --password-stdin

      - name: Mirror missing tags (multi-arch preserved)
        env:
          SRC_REPO: ghcr.io/openclaw/openclaw
          DST_REPO: docker.io/alpine/openclaw
        run: |
          set -euo pipefail

          echo "Fetching tags from source: $SRC_REPO"
          
          # Get date-based tags (excluding architecture-specific ones) and take the latest 10
          DATE_TAGS=$(skopeo list-tags docker://$SRC_REPO | jq -r '.Tags[] | select(test("-(amd64|arm64)$") | not) | select(. != "main" and . != "latest")' | sort -Vr | head -n 10)
          
          echo "Date-based tags to check: $DATE_TAGS"

          # Process each date-based tag
          for TAG in $DATE_TAGS; do
            echo "Checking if date-based tag exists on Docker Hub: $TAG"
            status=$(curl -sL "https://hub.docker.com/v2/repositories/alpine/openclaw/tags/$TAG")
            echo $status
            if [[ ( "${status}" =~ "not found" ) ]]; then
              echo "mirror image for $TAG"
              skopeo copy --all \
                "docker://$SRC_REPO:$TAG" \
                "docker://$DST_REPO:$TAG"
            else
              echo "Tag $TAG already exists on Docker Hub"
            fi
          done

          # Always mirror latest and main tags directly without checking
          echo "Mirroring latest and main tags directly..."
          skopeo copy --all \
            "docker://$SRC_REPO:latest" \
            "docker://$DST_REPO:latest"
          skopeo copy --all \
            "docker://$SRC_REPO:main" \
            "docker://$DST_REPO:main"
          echo "Latest and main tags mirrored."
